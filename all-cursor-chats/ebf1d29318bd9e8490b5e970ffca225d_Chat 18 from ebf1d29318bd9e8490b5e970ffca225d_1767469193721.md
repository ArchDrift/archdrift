# Chat: Chat 18 from ebf1d29318bd9e8490b5e970ffca225d

**Source:** ebf1d29318bd9e8490b5e970ffca225d/aiService.prompts
**Messages:** 1
**Recovered:** 2026-01-03T19:39:53.721Z

---

## unknown

We still have one layer violation missing.

Current behavior:

EmailServiceWrapper.js (under .../services/email-service/) importing from ../../api/... is flagged as a layer violation (service → api).

lexical.js (under ghost/core/core/server/lib/lexical.js) importing from ../api/endpoints/utils/serializers/output/posts is not flagged, but it should be (lib → api).

Our intended rules:

Any file path containing /lib/ should be classified as lib/infra layer.

Any import path containing /api/ should be classified as api layer.

lib → api is listed in FORBIDDEN_DEPENDENCIES and must produce a DriftGuard diagnostic.

Concretely, please:

Open the layer mapping code (detectLayer, resolveImportPath, the dependency checker).

Add a small unit test that uses the exact real values:

filePath = "ghost/core/core/server/lib/lexical.js"

importPath = "../api/endpoints/utils/serializers/output/posts"
and asserts:

sourceLayer === "lib" (or "infra", whichever we use)

targetLayer === "api"

dependency is treated as a violation.

Run this test (and the full suite) and see what the current logic returns for that pair.

If detectLayer does not classify ghost/.../lib/lexical.js as lib/infra, fix the matching so any path containing /lib/ in the normalized form is recognized.

If the import "../api/endpoints/utils/serializers/output/posts" is not resolving to a path containing /api/, fix resolveImportPath so that relative imports from lib up into api/... resolve correctly.

After you change the code so the new test passes and all existing tests still pass, briefly summarize:

What was wrong for the lexical.js case.

How the fix ensures lib → api imports are now detected as layer violations in real workspaces

---

