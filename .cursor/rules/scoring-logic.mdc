---
description: Formal definition of the Structural Integrity Index (SII) and scoring weights.
globs: src/engine/**/*.ts, src/analyzer/**/*.ts
alwaysApply: true
---

# DriftGuard Scoring Logic (Proportional Strict Mode)

## 1. Core Weighted Debt
- **Layer Violation:** 10 points (Fatal)
- **God Class Monolith (1501+ LOC):** 5 points (Critical)
- **N+1 Query:** 2 points (Reduced weight to account for DataLoaders)
- **God Class Large Class (801-1500 LOC):** Not counted in strict mode (only Monoliths count)

## 2. Structural Integrity Index (SII) Formula
Always use the **Density-Based** model with a **Logarithmic Floor**:

1. **WeightedViolations** = (Monoliths × 5) + (N1 × 2) + (Layer × 10)
2. **ViolationDensity** = WeightedViolations / TotalProductionFiles
3. **BaseScore** = 100 - (ViolationDensity × 100)
4. **LogarithmicFloor**:
   - If Density ≤ 1: `40 + (60 * e^(-Density * 2))`
   - If Density > 1: `40 + (10 * e^(-(Density - 1) * 0.5))` + square root decay: `max(floor, 100 - (sqrt(Density) * 50))`
5. **Final Score** = `max(BaseScore, LogarithmicFloor)` clamped between 0 and 100

## 3. Special Context
- **Isolation Bonus:** Reduce penalty if violations are in strictly isolated directories.
- **Debt Velocity:** Newness of code increases weight; old stable code has lower drift impact.
- **Test Files:** Scan but do NOT include in the SII calculation.
- **Production Code Filter:** Only files in `/src/` or `/core/` directories are counted.
